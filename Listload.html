<html>
    <head>
        <style>
            table {
                width: 100%
            }
            table, th, td, th {
                border: solid 1px #DDD;
                border-collapse: collapse;
                padding: 2px 3px;
                text-align: center;
                font-weight: normal;
            }
        </style>
        <script src="xmlToJson.js"></script>        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    </head>
    <body>
        <h1>Aqua Numbers ***This is not a Five9 product but a demo page to show how to utilize Five9 APIs</h1>
        <h2 id="info"></h2>
        <div id="formGroup" class="formGroup">
            <form action="">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" value ="" class="form-control">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" value="" class="form-control">
                <input type="button" class="btn btn-primary" value="Login" onclick="app()">
            </form>
        </div>
        <div id="loginSection"></div>
        <div id="listDropdown" hidden>
            <label for ="lists">Choose a campaign to add to:</label>
            <select name="lists" id="lists"></select>            
        </div>
        <br>
        <div id="compContainer" hidden>
            <label for="company">Company Title: </label>
            <select name="company" id="company" onchange="filter()"></select>
        </div>
        <br>
        <div id="btnContainer" hidden>                        
            <button onclick="addAll()" id="selectBtn" class="btn btn-secondary">Check All</button>            
        </div>
        <br>
        <div id="submitRecords" hidden>
            <button onclick="submitList()" class="btn btn-secondary">Add records to campaign</button>            
        </div>
        <br>
        <div id="container" style="width:500px;overflow:auto;"></div>        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    </body>
    <script>       

        var listNumbers = [];
        var addNumbers = [];
        var removeNumbers = [];
        var selectAll = true;
        mainArea = document.getElementById('info');
        var successLogin = false;
        var listIdentifier = document.getElementById("lists");
        var myHeaders = {};
        var url = "";
        const re = /<return>(.*)<\/return>/;
        const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay));
        company = "all";
        var encodedString = "";
        recordsDeleted = 0;        

        function filter() {            
            console.log(removeNumbers);
            document.getElementById("container").innerHTML="";   
            var e = document.getElementById("company");
            var value = e.value;            
            createTable(listNumbers, value);
        }

        async function app() {
            url = "https://api.five9.com:443/wsadmin/v13/AdminWebService";

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const userString = `${username}:${password}`;
            encodedString = btoa(userString);            
            
            myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/xml");
            myHeaders.append("Authorization", `Basic ${encodedString}`)            
            if (successLogin === false) {
                successLogin = await userLogin(url, myHeaders, username);
            }
            if (successLogin === true) {
                const lists = await getLists(url, myHeaders);
                parseListsXML(lists);
                const identifier = await runReport(url, myHeaders, re);
                await isReportRunning(url, myHeaders, identifier, re);                
                const report = await getReportResult(url, myHeaders, identifier);
                listNumbers = parseNumbersXMLS(report);
                companyList(listNumbers);
                createTable(listNumbers, company);
            }
        }        

        function addAll() {
            document.getElementById("btnContainer").onclick = function() {
                var inputs = document.getElementsByTagName("input");      
                var newNumber = "";      
                for(var i = 3; i < inputs.length; i++) {
                    if(inputs[i].type == "checkbox") {
                        inputs[i].checked = true;
                    }                
                    //newNumber = inputs[i].value;
                    if (addNumbers.includes(inputs[i].value)) {

                    } else {
                        addNumbers.push(inputs[i].value);
                        console.log(newNumber);
                    }
                }
                console.log(addNumbers);
            }
            //console.log(addNumbers);
        } 

        async function userLogin(url, myHeaders, username) {
            var raw = `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://service.admin.ws.five9.com/"> <soapenv:Header/> <soapenv:Body> <ser:getUserGeneralInfo> <userName>${username}</userName> </ser:getUserGeneralInfo> </soapenv:Body> </soapenv:Envelope>`            
            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
            };

            const loginSection = document.getElementById("loginSection");            
            
            try {
                const response = await fetch(url, requestOptions);
                if (response.status === 401) {
                    throw new Error('Unauthorized Access');
                } else if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const success = await response.text();
                loginSection.innerHTML = "<p style='color:black'>Logged In</p>";
                return true;

            } catch (error) {
                loginSection.innerHTML = "<p style='color:red'>Error Logging In!</p>";
                console.error(error);
                return false;
            }
        }

        async function getLists(url, myHeaders) {
            var raw = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://service.admin.ws.five9.com/">   <soapenv:Header/>   <soapenv:Body>      <ser:getListsInfo>      </ser:getListsInfo>   </soapenv:Body></soapenv:Envelope>'

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
            };
            try {
                const response = await fetch(url, requestOptions);
                if (!response.ok) {
                    throw new Error (`HTTP error! status: ${response.status}`);
                }
                const lists = await response.text();
                return lists;
            } catch (error) {
                console.error(error);
            }
        }

        function parseListsXML(lists) {
            var listNames = [];
            var json = xmlToJson.parse(lists);
            let i = 0;
            while (i < json['env:Envelope']['env:Body']['ns2:getListsInfoResponse']['return'].length) {
                listNames.push(json['env:Envelope']['env:Body']['ns2:getListsInfoResponse']['return'][i]['name']);
                i++;
            }
            //console.log(listNames);
            listLocation = document.getElementById('listDropdown');
            listLocation.removeAttribute("hidden");
            document.getElementById("btnContainer").removeAttribute("hidden");
            document.getElementById("compContainer").removeAttribute("hidden");
            document.getElementById("submitRecords").removeAttribute("hidden");
            var select = document.getElementById('lists');            
            for (i = 0; i < listNames.length; i++) {
                var opt = listNames[i];
                var el = document.createElement('option');
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
            } 
        }

        async function runReport(url, myHeaders, re) {
            var raw = "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ser=\"http://service.admin.ws.five9.com/\">\r\n    <soapenv:Header/>\r\n    <soapenv:Body>\r\n        <ser:runReport>\r\n            <!--Optional:-->\r\n            <folderName>Shared Reports</folderName>\r\n            <!--Optional:-->\r\n            <reportName>List Details2</reportName>\r\n            <!--Optional:-->\r\n            <criteria>\r\n                <time>\r\n                    <!--Optional:-->\r\n                    <end>2026-12-31T23:00:00.000-07:00</end>\r\n                    <!--Optional:-->\r\n                    <start>2023-01-01T00:00:00.000-07:00</start>\r\n                </time>\r\n            </criteria>\r\n        </ser:runReport>\r\n    </soapenv:Body>\r\n</soapenv:Envelope>";

                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: raw,
                    redirect: 'follow'
                };
                try {
                    const response = await fetch(url, requestOptions);

                    if (!response.ok) {
                        throw new Error (`HTTP error! status: ${response.status}`);
                    }
                    const identifier = await response.text();
                    const identifierString = identifier.match(re);
                    return identifierString[1];                    
                } catch (error) {
                    console.error(error);
                }
        }

        async function isReportRunning(url, myHeaders, identifierString, re) {
            var raw = `<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ser=\"http://service.admin.ws.five9.com/\">\r\n   <soapenv:Header/>\r\n   <soapenv:Body>\r\n      <ser:isReportRunning>\r\n         <!--Optional:-->\r\n         <identifier>${identifierString}</identifier>\r\n      </ser:isReportRunning>\r\n   </soapenv:Body>\r\n</soapenv:Envelope>`

            var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: raw,
                    redirect: 'follow'
                }; 

            try {
                const response = await fetch(url, requestOptions);

                if (!response.ok) {
                    throw new Error (`HTTP error! status: ${response.status}`);
                }
                const running = await response.text();
                var isRunning = running.match(re);                
                if (isRunning[1] == "true") {
                    await sleep(5000)
                    isReportRunning(url, myHeaders, identifierString, re);
                }
                if (isRunning[1] == "false") {
                    return "done";
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function getReportResult(url, myHeaders, identifierString) {
            var raw = `<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ser=\"http://service.admin.ws.five9.com/\">\r\n   <soapenv:Header/>\r\n   <soapenv:Body>\r\n      <ser:getReportResult>\r\n         <!--Optional:-->\r\n         <identifier>${identifierString}</identifier>\r\n      </ser:getReportResult>\r\n   </soapenv:Body>\r\n</soapenv:Envelope>`

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
                };
            try {
                const response = await fetch(url, requestOptions);

                if (!response.ok) {
                    throw new Error (`HTTP error! status: ${response.status}`);
                }
                const report = await response.text();
                return report
            } catch (error) {
                console.error(error);
            }
        }

        function parseNumbersXMLS(report) {            
            var json = xmlToJson.parse(report);
            //console.log(json);
            //console.log(json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][0]['values']['data'][0])
            let i = 0;
            while (i < json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'].length) {
                listNumbers.push([json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][i]['values']['data'][0], json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][i]['values']['data'][1], json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][i]['values']['data'][2], json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][i]['values']['data'][3], json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][i]['values']['data'][4], json['env:Envelope']['env:Body']['ns2:getReportResultResponse']['return']['records'][i]['values']['data'][5]]);
                i++;
            }
            return listNumbers;
        }

        function createTable(numbers, company) {
            console.log(removeNumbers);
            console.log("Creating new table");
            var data = ['First Name', 'Last Name', 'Number', 'Company', 'Add to list'];

            tablearea = document.getElementById('container');
            table = document.createElement('table');  
            table.setAttribute('id', 'myTable');
            table.setAttribute('class', 'table');
            thead = document.createElement('thead');
            tr = document.createElement('tr');

            for (var i = 0; i < data.length; i++) {
                var headerTxt = document.createTextNode(data[i]);
                th = document.createElement('th');
                th.appendChild(headerTxt);
                tr.appendChild(th);
                thead.appendChild(tr);
            }

            table.appendChild(thead);
                        
            for (var i = 0; i < numbers.length; i++) {
                //console.log(numbers[i][2])
                if (company == "all") {
                    if (typeof numbers[i][2] == "object") {
                        phoneNumber = numbers[i][4]
                    } else {
                        phoneNumber = numbers[i][2]
                    }
                    //console.log(typeof numbers[i][2])
                    tr = document.createElement('tr');
                    tr.appendChild(document.createElement('td'));
                    tr.appendChild(document.createElement('td'));
                    tr.appendChild(document.createElement('td'));
                    tr.appendChild(document.createElement('td'));
                    tr.appendChild(document.createElement('td'));

                    var callCheckbox = document.createElement("INPUT");
                    callCheckbox.type = "checkbox";
                    callCheckbox.setAttribute('id', 'row' + i);
                    callCheckbox.setAttribute('value', phoneNumber);
                    callCheckbox.setAttribute('onclick', 'addToListBulk(this)');

                    tr.cells[0].appendChild(document.createTextNode(numbers[i][0]));
                    tr.cells[1].appendChild(document.createTextNode(numbers[i][1]));
                    tr.cells[2].appendChild(document.createTextNode(phoneNumber));
                    tr.cells[3].appendChild(document.createTextNode(numbers[i][5]))
                    tr.cells[4].appendChild(callCheckbox);

                    table.appendChild(tr);
                } else {
                    if (numbers[i][5] == company) {
                        console.log(numbers[i][2]);
                        if (typeof numbers[i][2] == "object") {
                        phoneNumber = numbers[i][4]
                        } else {
                            phoneNumber = numbers[i][2]
                        }
                        console.log("Does list contain " + phoneNumber + " " + numbers[i].includes(phoneNumber));
                        console.log("Does list contain " + phoneNumber + " " + listNumbers[i].includes(phoneNumber));
                        console.log("Does list contain " + phoneNumber + " " + removeNumbers.includes(String(phoneNumber)));
                        //console.log(typeof(phoneNumber));
                        if (!removeNumbers.includes(String(phoneNumber))) {
                            //console.log(typeof numbers[i][2])
                            tr = document.createElement('tr');
                            tr.appendChild(document.createElement('td'));
                            tr.appendChild(document.createElement('td'));
                            tr.appendChild(document.createElement('td'));
                            tr.appendChild(document.createElement('td'));
                            tr.appendChild(document.createElement('td'));

                            var callCheckbox = document.createElement("INPUT");
                            callCheckbox.type = "checkbox";
                            callCheckbox.setAttribute('id', 'row' + i);
                            callCheckbox.setAttribute('value', phoneNumber);
                            callCheckbox.setAttribute('onclick', 'addToListBulk(this)');
                            if (addNumbers.includes(String(phoneNumber))) {
                                callCheckbox.setAttribute("checked", true);
                            };

                            tr.cells[0].appendChild(document.createTextNode(numbers[i][0]));
                            tr.cells[1].appendChild(document.createTextNode(numbers[i][1]));
                            tr.cells[2].appendChild(document.createTextNode(phoneNumber));
                            tr.cells[3].appendChild(document.createTextNode(numbers[i][5]))
                            tr.cells[4].appendChild(callCheckbox);

                            table.appendChild(tr);
                        }
                    }
                }
            }
            
            tablearea.appendChild(table);            
    }

    function companyList(numbers) {        
            companyNames = [];
            var select = document.getElementById('company');
            var el = document.createElement('option');
            el.textContent = "all";
            el.value = "all";
            select.appendChild(el);
            for (i = 0; i < numbers.length; i++) {
                if (!companyNames.includes(numbers[i][5])) {
                    var opt = numbers[i][5];
                    el = document.createElement('option');
                    el.textContent = opt;
                    el.value = opt;
                    select.appendChild(el);
                    companyNames.push(numbers[i][5]);
                }
            } 
    }

    function addToListBulk(number) {
        if (document.getElementById(number.id).checked) {
            addNumbers.push(number.value)
        } else {
            var index = addNumbers.indexOf(number.value);
            if (index > -1) {
                addNumbers.splice(index, 1);
            }
        }
        //console.log(addNumbers);
    }

    function submitList() { 
        if (addNumbers.length > 0) {
            console.log(listIdentifier.value);
            var text = listIdentifier.options[listIdentifier.selectedIndex].text;
            const response = confirm(`Are you sure you want to add ${addNumbers.length} numbers to ${text}?`);    
            if (response === true) {
                submitRecord(0);        
            }
        }
    }



    function addToList(number) {
        var text = listIdentifier.options[listIdentifier.selectedIndex].text;
        console.log(listIdentifier.value);
        const response = confirm(`Are you sure you want to add ${number} to ${text}?`);    
        if (response === true) {
            submitRecord(number);        
        }
    }


    async function submitRecord(number) {
            document.getElementById('listDropdown').setAttribute("hidden", true);
            document.getElementById("btnContainer").setAttribute("hidden", true);
            document.getElementById("compContainer").setAttribute("hidden", true);
            document.getElementById("submitRecords").setAttribute("hidden", true);
            document.getElementById("loginSection").innerHTML = "MOVING RECORDS";
        if (addNumbers.length > 0) {
            for (var i = 0; i < addNumbers.length; i++) {
                var text = listIdentifier.options[listIdentifier.selectedIndex].text;
                tablearea.innerHTML = "";        
                var requestOptions = {
                    method: "POST"
                };

                console.log('Sending number: ' + addNumbers[i])
                fetch(`https://api.five9.com/web2campaign/AddToList?F9domain=Five9 TAM DEMO - Daniel Garcia&F9key=number1&number1=${addNumbers[i]}&F9list=${text}`, requestOptions)
                .then(response => response.text())                
                .catch(error => console.log('error', error));

                await deleteRecord(addNumbers[i]);
                removeNumbers.push(addNumbers[i]);
            }
        }
        document.getElementById('listDropdown').removeAttribute("hidden");
        document.getElementById("btnContainer").removeAttribute("hidden");
        document.getElementById("compContainer").removeAttribute("hidden");
        document.getElementById("submitRecords").removeAttribute("hidden");
        document.getElementById("loginSection").innerHTML = "";
        filter();
    }

    async function deleteRecord(number) {          
        console.log("Deleting: " + number);
        recordsDeleted += 1;
        myHeaders2 = new Headers();
        myHeaders2.append("Content-Type", "application/xml");
        myHeaders2.append("Authorization", `Basic ${encodedString}`)
        var raw = `<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ser=\"http://service.admin.ws.five9.com/\">   <soapenv:Header/>   <soapenv:Body>      <ser:deleteFromList>                  <listName>Test</listName>                  <listDeleteSettings>            <allowDataCleanup>true</allowDataCleanup>            <fieldsMapping>               <columnNumber>1</columnNumber>                              <fieldName>number1</fieldName>               <key>true</key>            </fieldsMapping>            <listDeleteMode>DELETE_ALL</listDeleteMode>         </listDeleteSettings>         <importData>                     <values>                              <item>${number}</item>            </values>         </importData>      </ser:deleteFromList>   </soapenv:Body></soapenv:Envelope>`
        var requestOptions = {
            method: 'POST',
            headers: myHeaders2,
            body: raw,
            redirect: 'follow'
        }        
        //console.log(requestOptions);
        //console.log(raw);
        const response = await fetch(url, requestOptions);

        if (!response.ok) {
            const message = `An error has occured: ${response.status}`;

            throw new Error(message);
            document.getElementById("loginSection").innerHTML = "ERROR! Please see logs!";
        } else {
            listNumbers.pop(addNumbers[i]);            
        }
        if (recordsDeleted == 20) {
            console.log("Pausing for 60 seconds");
            await sleep(60000);
            recordsDeleted = 0;
        }
    }
        
    
    async function submitRecord2(number) {
        console.log(addNumbers.length);

        if (addNumbers.length > 0) {                
            for (var i = 0; i < addNumbers.length; i++) {
                var text = listIdentifier.options[listIdentifier.selectedIndex].text;
                tablearea.innerHTML = "";        
                var requestOptions = {
                    method: 'POST'                
                };
                
                console.log('Sending number: ' + number)
                fetch(`https://api.five9.com/web2campaign/AddToList?F9domain=Five9 TAM DEMO - Daniel Garcia&F9key=number1&number1=${addNumbers[i]}&F9list=${text}`, requestOptions)
                .then(response => response.text())
                .then(result => console.log(result))
                .catch(error => console.log('error', error));
                
                var raw = `<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ser=\"http://service.admin.ws.five9.com/\">   <soapenv:Header/>   <soapenv:Body>      <ser:deleteFromList>                  <listName>Test</listName>                  <listDeleteSettings>            <allowDataCleanup>true</allowDataCleanup>            <fieldsMapping>               <columnNumber>1</columnNumber>                              <fieldName>number1</fieldName>               <key>true</key>            </fieldsMapping>            <listDeleteMode>DELETE_ALL</listDeleteMode>         </listDeleteSettings>         <importData>                     <values>                              <item>${addNumbers[i]}</item>            </values>         </importData>      </ser:deleteFromList>   </soapenv:Body></soapenv:Envelope>`
                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: raw,
                    redirecto: 'follow'
            }
            //console.log(raw);
            const response = await fetch(url, requestOptions);

            console.log(response);
            if (!response.ok) {
                const message = `An error has occured: ${response.status}`;
                throw new Error(message);
                } else {
                    listNumbers.pop(addNumbers[i]);
                    removeNumbers.push(addNumbers[i]);
                    console.log("Does list contain " + addNumbers[i] + " " + listNumbers.includes(addNumbers[i]));
                }        
        }};
        await sleep(2000)
        //app();            
        filter();
    }
    </script>
</html>
